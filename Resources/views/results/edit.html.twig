{% extends '@IServCore/page.html.twig' %}

{% block title %}
    Ergebnisse für {{ participant.vorname }} {{ participant.nachname }}
{% endblock %}

{% block content %}

<div class="container mt-4">

    <h2>
        <i class="fa fa-pencil-alt"></i>
        Ergebnisse – {{ participant.vorname }} {{ participant.nachname }}
    </h2>

    <p>
        <strong>Geschlecht:</strong> {{ participant.geschlecht }}<br>
        <strong>Altersjahr:</strong> {{ participant.age_year }}<br>
        <strong>Prüfungsjahr:</strong> {{ participant.exam_year }}
    </p>

    <hr>

    <table class="table table-striped results-table">
        <thead>
            <tr>
                <th>Disziplin</th>
                <th>Kategorie</th>
                <th>Leistung</th>
                <th>Einheit</th>
                <th>Bewertung</th>
            </tr>
        </thead>

        <tbody>
        {% for d in disciplines %}
            {% set r = results[d.id] ?? null %}
            <tr data-discipline="{{ d.id }}">
                <td>{{ d.name }}</td>
                <td>{{ d.kategorie }}</td>

                <td style="width: 150px;">
                    <input type="number"
                           class="form-control input-leistung"
                           value="{{ r.leistung ?? '' }}"
                           step="0.01"
                           data-discipline="{{ d.id }}">
                </td>

                <td>{{ d.einheit }}</td>

                <td>
                    <span class="badge bg-secondary result-badge" id="badge-{{ d.id }}">
                        {{ r.stufe ?? "-" }}
                    </span>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll(".input-leistung").forEach(el => {
        el.addEventListener("change", () => saveResult(el));
    });

    function saveResult(el) {

        const disciplineId = el.dataset.discipline;
        const leistung     = el.value;

        fetch("{{ path('sportabzeichen_results_save') }}", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: new URLSearchParams({
                ep_id: "{{ epId }}",
                discipline_id: disciplineId,
                leistung: leistung
            })
        })
        .then(r => r.text())
        .then(txt => {
            const badge = document.getElementById("badge-" + disciplineId);
            badge.innerText = txt.includes("OK") ? "✓ gespeichert" : "?" ;
            badge.classList.remove("bg-secondary");
            badge.classList.add("bg-success");

            setTimeout(() => {
                badge.classList.remove("bg-success");
                badge.classList.add("bg-secondary");
                badge.innerText = "-";
            }, 1200);
        });
    }

});
</script>

{% endblock %}
