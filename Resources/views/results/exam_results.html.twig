{% extends '@IServCore/page.html.twig' %}

{% block title %}
    Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2>üèÖ Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})</h2>

    {# Klassenfilter ------------------------------------------------ #}
    <form method="get" class="mb-3 d-flex align-items-center gap-2">
        <label class="fw-bold mb-0 me-2">Klasse:</label>

        <select name="class" class="form-select w-auto d-inline">
            <option value="">(Alle Klassen)</option>
            {% for c in classes %}
                <option value="{{ c.klasse }}"
                    {% if selectedClass == c.klasse %}selected{% endif %}
                >
                    {{ c.klasse }}
                </option>
            {% endfor %}
        </select>

        <button type="submit" class="btn btn-primary">Filtern</button>
    </form>


    {# Ergebnistabelle und Speichern -------------------------------- #}
    <form action="{{ path('sportabzeichen_results_save_all', {examId: exam.id}) }}"
          method="post">

        <table class="table table-bordered align-middle mt-3">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Alter</th>

                    {% for category, items in disciplines %}
                        <th>{{ category }}</th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
            {% for p in participants %}

                {% set epResults = results[p.ep_id] ?? {} %}

                <tr>
                    <td>{{ p.vorname }} {{ p.nachname }}</td>
                    <td>{{ p.age_year }}</td>

                    {% for category, items in disciplines %}

                        {# passende Disziplinen f√ºr diese Kategorie / Geschlecht / Alter #}
                        {% set options = [] %}
                        {% for d in items %}
                            {% if
                                d.geschlecht == p.gender
                                and p.age_year >= d.age_min
                                and p.age_year <= d.age_max
                            %}
                                {% set options = options|merge([d]) %}
                            {% endif %}
                        {% endfor %}

                        {# falls Ergebnis existiert ‚Üí Disziplin bestimmen #}
                        {% set selectedDiscId = null %}
                        {% for d in options %}
                            {% if epResults[d.id] is defined %}
                                {% set selectedDiscId = d.id %}
                            {% endif %}
                        {% endfor %}

                        {# Leistungswert zuordnen #}
                        {% set selectedValue = '' %}
                        {% if selectedDiscId and epResults[selectedDiscId] is defined %}
                            {% set selectedValue = epResults[selectedDiscId].leistung %}
                        {% endif %}

                        <td>

                            {# Disziplin-Dropdown #}
                            <select name="results[{{ p.ep_id }}][{{ category }}][discipline]"
                                    class="form-select">

                                <option value="">(keine Auswahl)</option>

                                {% for d in options %}
                                    {% set preselect = 
                                        (selectedDiscId == d.id) 
                                        or (selectedDiscId is null and d.auswahlnummer == 1)
                                    %}
                                    <option value="{{ d.id }}" {% if preselect %}selected{% endif %}>
                                        {{ d.name }}
                                    </option>
                                {% endfor %}
                            </select>

                            {# Leistungsfeld #}
                            <input type="number"
                                name="results[{{ p.ep_id }}][{{ category }}][leistung]"
                                step="0.01"
                                class="form-control mt-1"
                                value="{{ selectedValue }}">
                        </td>

                    {% endfor %}
                </tr>

            {% endfor %}
            </tbody>
        </table>

        <div class="text-end mt-3">
            <button type="submit" class="btn btn-success btn-lg">
                üíæ Alle Ergebnisse speichern
            </button>
        </div>

    </form>

</div>
{% endblock %}
