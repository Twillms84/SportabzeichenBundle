{# 3. DISZIPLINEN #}
                        {% for category, items in disciplines %}
                            {% if category|upper not in ['SWIMMING', 'SCHWIMMEN'] %}
                                
                                {# --- LOGIK START: Optionen sammeln --- #}
                                {% set options = [] %}
                                {% set pGender = p.geschlecht %} 
                                
                                {# Wir iterieren durch Disziplinen UND deren Requirements #}
                                {% for discipline in items %}
                                    {% if discipline.requirements is defined %}
                                        {% for req in discipline.requirements %}
                                            {# Filterung nach Alter/Geschlecht #}
                                            {% if req.gender == pGender and p.age_year >= req.minAge and p.age_year <= req.maxAge %}
                                                {# Merge Disziplin-Daten in das Requirement #}
                                                {% set combo = req|merge({'discipline': discipline}) %}
                                                {% set options = options|merge([combo]) %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}

                                {# --- LOGIK: Welches Ergebnis ist ausgewählt? --- #}
                                {% set selectedReq = null %}
                                {% set resObj = null %}

                                {# Haben wir schon ein Ergebnis für eine der möglichen Disziplinen? #}
                                {% for req in options %}
                                    {% if epResults[req.discipline.id] is defined %}
                                        {% set selectedReq = req %}
                                        {% set resObj = epResults[req.discipline.id] %}
                                    {% endif %}
                                {% endfor %}

                                {# Fallback: Erste Option wählen #}
                                {% if selectedReq is null and options|length > 0 %}
                                    {% set selectedReq = options[0] %}
                                {% endif %}
                                
                                {# CSS Klasse für Medaille bestimmen #}
                                {% set mClass = 'medal-none' %}
                                {% if resObj %}
                                    {% if resObj.points == 3 %}{% set mClass = 'medal-gold' %}
                                    {% elseif resObj.points == 2 %}{% set mClass = 'medal-silber' %}
                                    {% elseif resObj.points == 1 %}{% set mClass = 'medal-bronze' %}
                                    {% endif %}
                                {% endif %}

                                <td class="p-1 col-discipline col-cat-{{ category }}">
                                    <div class="d-flex flex-column">
                                        
                                        {# --- DROPDOWN --- #}
                                        <select class="discipline-selector js-discipline-select mb-1 {{ mClass }}" 
                                                data-save 
                                                data-ep-id="{{ p.ep_id }}" 
                                                data-type="discipline" 
                                                data-kategorie="{{ category }}">
                                            
                                            {% if options is empty %}
                                                <option value="">--</option>
                                            {% else %}
                                                {% for req in options %}
                                                    {% set cleanUnit = unitMap[req.discipline.unit] ?? req.discipline.unit %}
                                                    <option value="{{ req.discipline.id }}" 
                                                            {{ selectedReq.discipline.id == req.discipline.id ? 'selected' : '' }}
                                                            data-unit="{{ cleanUnit }}"
                                                            data-bronze="{{ req.bronze }}"
                                                            data-silber="{{ req.silver }}"
                                                            data-gold="{{ req.gold }}">
                                                        {{ req.discipline.name }}
                                                    </option>
                                                {% endfor %}
                                            {% endif %}
                                        </select>

                                        {# --- INPUT FELD --- #}
                                        <div class="input-group input-group-sm">
                                            <input type="text" 
                                                   class="form-control form-control-custom {{ mClass }}"
                                                   value="{{ resObj ? resObj.leistung : '' }}"
                                                   data-save 
                                                   data-ep-id="{{ p.ep_id }}" 
                                                   data-type="leistung" 
                                                   data-kategorie="{{ category }}">
                                        </div>

                                        {# --- HINTS (Werte für B/S/G) --- #}
                                        <div class="req-hint">
                                            <span class="req-val-b" title="Bronze">B:<span class="js-val-b">{{ selectedReq ? selectedReq.bronze : '-' }}</span></span>
                                            <span class="req-val-s" title="Silber">S:<span class="js-val-s">{{ selectedReq ? selectedReq.silver : '-' }}</span></span>
                                            <span class="req-val-g" title="Gold">G:<span class="js-val-g">{{ selectedReq ? selectedReq.gold : '-' }}</span></span>
                                        </div>
                                    </div>
                                </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/exam_results_autosave.js', 'pulsr-sportabzeichen') }}"></script>
    {# Hier binden wir das externe UI-Script ein #}
    <script src="{{ asset('js/exam_results_ui.js', 'pulsr-sportabzeichen') }}"></script>
{% endblock %}