{% extends '@IServCore/page.html.twig' %}

{% block title %}
    Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2>üèÖ Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})</h2>

    {# 1. Routen und Tokens f√ºr JS bereitstellen #}
    <script nonce="{{ nonce }}">
        window.IServ = window.IServ || {};
        window.IServ.routes = window.IServ.routes || {};
        window.IServ.csrfToken = window.IServ.csrfToken || {};
        
        window.IServ.routes.sportabzeichen_exam_result_save = "{{ path('sportabzeichen_results_exam_result_save') }}";
        window.IServ.csrfToken.sportabzeichen_result_save = "{{ csrf_token('sportabzeichen_result_save') }}";
    </script>

    {# Klassenfilter #}
    <form action="{{ path('sportabzeichen_results_save_all', {examId: exam.id}) }}" 
      method="post"
      data-global-route="{{ path('sportabzeichen_results_exam_result_save') }}"
      data-global-token="{{ csrf_token('sportabzeichen_result_save') }}">
        <label class="fw-bold mb-0 me-2">Klasse:</label>
        <select name="class" class="form-select w-auto d-inline">
            <option value="">(Alle Klassen)</option>
            {% for c in classes %}
                <option value="{{ c.klasse }}" {% if selectedClass == c.klasse %}selected{% endif %}>
                    {{ c.klasse }}
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtern</button>
    </form>

    <form action="{{ path('sportabzeichen_results_save_all', {examId: exam.id}) }}" method="post">
        <table class="table table-bordered align-middle mt-3">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Alter</th>
                    {% for category, items in disciplines %}
                        {% if category|upper != 'SWIMMING' %}
                            <th>{{ category }}</th>
                        {% endif %}
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
            {% for p in participants %}
                {% set epResults = results[p.ep_id] ?? {} %}
                <tr>
                    <td>{{ p.vorname }} {{ p.nachname }}</td>
                    <td>{{ p.age_year }}</td>

                    {% for category, items in disciplines %}
                        {% if category|upper != 'SWIMMING' %}

                            {% set options = [] %}
                            {% for d in items %}
                                {% if d.geschlecht == p.gender and p.age_year >= d.age_min and p.age_year <= d.age_max %}
                                    {% set options = options|merge([d]) %}
                                {% endif %}
                            {% endfor %}

                            {# Logik zur Vorselektion der Disziplin #}
                            {% set selectedDiscId = null %}
                            {% for d in options %}
                                {% if epResults[d.id] is defined %}
                                    {% set selectedDiscId = d.id %}
                                {% endif %}
                            {% endfor %}

                            {# Standardm√§√üig erste Disziplin w√§hlen, wenn noch nichts gespeichert ist #}
                            {% if selectedDiscId is null and options|length > 0 %}
                                {% set selectedDiscId = options[0].id %}
                            {% endif %}

                            {% set selectedValue = '' %}
                            {% if selectedDiscId and epResults[selectedDiscId] is defined %}
                                {% set selectedValue = epResults[selectedDiscId].leistung %}
                            {% endif %}

                            <td>
                                {# Disziplin-Dropdown: ID-Zuweisung hilft dem JS beim Abgleichen #}
                                <select name="results[{{ p.ep_id }}][{{ category }}][discipline]"
                                        id="disc-select-{{ p.ep_id }}-{{ loop.index }}"
                                        class="form-select discipline-selector"
                                        data-save
                                        data-ep-id="{{ p.ep_id }}"
                                        data-type="discipline"
                                        data-target-input="leistung-input-{{ p.ep_id }}-{{ loop.index }}">
                                    <option value="">(keine Auswahl)</option>
                                    {% for d in options %}
                                        <option value="{{ d.id }}" {% if selectedDiscId == d.id %}selected{% endif %}>
                                            {{ d.name }}
                                        </option>
                                    {% endfor %}
                                </select>

                                {# Leistungsfeld #}
                                <input type="text" 
                                    id="leistung-input-{{ p.ep_id }}-{{ loop.index }}"
                                    name="results[{{ p.ep_id }}][{{ category }}][leistung]"
                                    class="form-control mt-1"
                                    placeholder="Wert"
                                    value="{{ selectedValue }}"
                                    data-save
                                    data-ep-id="{{ p.ep_id }}"
                                    data-discipline-id="{{ selectedDiscId }}"
                                    data-type="leistung">
                            </td>

                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <div class="text-end mt-3">
            <button type="submit" class="btn btn-success btn-lg">
                üíæ Alle Ergebnisse speichern
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# Hier laden wir die von Webpack generierte Datei mit dem richtigen Package-Namen #}
    <script type="text/javascript" src="{{ asset('js/exam_results_autosave.js', 'pulsr-sportabzeichen') }}"></script>
{% endblock %}