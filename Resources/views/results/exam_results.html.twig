{% extends '@IServCore/page.html.twig' %}

{% block title %}
    Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {# L√§dt das generierte CSS f√ºr die Medaillenfarben #}
    {{ iserv_bundle_css('PulsRSportabzeichen', 'css/sportabzeichen_results') }}
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2>üèÖ Ergebnisse eingeben ‚Äì {{ exam.exam_name }} ({{ exam.exam_year }})</h2>

    {# 1. Klassenfilter (Nur GET-Request zum Filtern) #}
    <form method="get" class="mb-3 d-flex align-items-center gap-2">
        <label class="fw-bold mb-0 me-2">Klasse:</label>
        <select name="class" class="form-select w-auto d-inline">
            <option value="">(Alle Klassen)</option>
            {% for c in classes %}
                <option value="{{ c.klasse }}" {% if selectedClass == c.klasse %}selected{% endif %}>
                    {{ c.klasse }}
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtern</button>
    </form>

    {# 2. Hauptformular f√ºr die Tabelle mit Autosave-Attributes #}
    <form action="{{ path('sportabzeichen_results_save_all', {examId: exam.id}) }}" 
          method="post"
          id="autosave-form"
          data-global-route="{{ path('sportabzeichen_results_exam_result_save') }}"
          data-global-token="{{ csrf_token('sportabzeichen_result_save') }}">

        <table class="table table-bordered align-middle mt-3">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Alter</th>
                    {% for category, items in disciplines %}
                        {% if category|upper != 'SWIMMING' %}
                            <th>{{ category }}</th>
                        {% endif %}
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
            {% for p in participants %}
                {% set epResults = results[p.ep_id] ?? {} %}
                <tr>
                    <td>{{ p.vorname }} {{ p.nachname }}</td>
                    <td>{{ p.age_year }}</td>

                    {% for category, items in disciplines %}
                        {% if category|upper != 'SWIMMING' %}

                            {# Verf√ºgbare Disziplinen f√ºr diesen Teilnehmer filtern #}
                            {% set options = [] %}
                            {% for d in items %}
                                {% if d.geschlecht == p.gender and p.age_year >= d.age_min and p.age_year <= d.age_max %}
                                    {% set options = options|merge([d]) %}
                                {% endif %}
                            {% endfor %}

                            {# Aktuelle Auswahl und Leistung ermitteln #}
                            {% set selectedDiscId = null %}
                            {% for d in options %}
                                {% if epResults[d.id] is defined %}
                                    {% set selectedDiscId = d.id %}
                                {% endif %}
                            {% endfor %}

                            {# Default: Erste Disziplin nehmen, falls keine gespeichert #}
                            {% if selectedDiscId is null and options|length > 0 %}
                                {% set selectedDiscId = options[0].id %}
                            {% endif %}

                            {% set selectedValue = '' %}
                            {% set medalClass = 'medal-none' %}
                            
                            {% if selectedDiscId and epResults[selectedDiscId] is defined %}
                                {% set resObj = epResults[selectedDiscId] %}
                                {% set selectedValue = resObj.leistung %}
                                
                                {# Medaillen-Klasse f√ºr das Laden der Seite berechnen #}
                                {% if resObj.points is defined %}
                                    {% if resObj.points == 3 %}{% set medalClass = 'medal-gold' %}
                                    {% elseif resObj.points == 2 %}{% set medalClass = 'medal-silver' %}
                                    {% elseif resObj.points == 1 %}{% set medalClass = 'medal-bronze' %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            <td>
                                {# Disziplin-Dropdown #}
                                <select name="results[{{ p.ep_id }}][{{ category }}][discipline]"
                                        id="disc-select-{{ p.ep_id }}-{{ loop.index }}"
                                        class="form-select discipline-selector {{ medalClass }}"
                                        data-save
                                        data-ep-id="{{ p.ep_id }}"
                                        data-type="discipline"
                                        data-target-input="leistung-input-{{ p.ep_id }}-{{ loop.index }}">
                                    <option value="">(keine Auswahl)</option>
                                    {% for d in options %}
                                        <option value="{{ d.id }}" {% if selectedDiscId == d.id %}selected{% endif %}>
                                            {{ d.name }}
                                        </option>
                                    {% endfor %}
                                </select>

                                {# Leistungsfeld #}
                                <input type="text" 
                                    id="leistung-input-{{ p.ep_id }}-{{ loop.index }}"
                                    name="results[{{ p.ep_id }}][{{ category }}][leistung]"
                                    class="form-control mt-1 {{ medalClass }}"
                                    placeholder="Wert"
                                    value="{{ selectedValue }}"
                                    data-save
                                    data-ep-id="{{ p.ep_id }}"
                                    data-discipline-id="{{ selectedDiscId }}"
                                    data-type="leistung">
                            </td>

                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <div class="text-end mt-3">
            <button type="submit" class="btn btn-success btn-lg">
                üíæ Alle Ergebnisse speichern
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# L√§dt das Autosave-Skript (Senden der Daten) #}
    {{ iserv_bundle_js('PulsRSportabzeichen', 'js/exam_results_autosave') }}
    {# L√§dt das Scoring-Skript (Farben umschalten basierend auf Server-Antwort) #}
    {{ iserv_bundle_js('PulsRSportabzeichen', 'js/exam_results_scoring') }}
{% endblock %}